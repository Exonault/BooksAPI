@page "/login"
@using Blazored.SessionStorage
@using BooksAPI.FE.Contracts.User
@using BooksAPI.FE.Interfaces
@using BooksAPI.FE.Model
@inject ISessionStorageService SessionStorageService;
@inject IUserService UserService;
@inject NavigationManager NavigationManager

<PageTitle>Login</PageTitle>
<h3 class="text-center mb-4">Login</h3>
@if (true)
{
    <MudGrid Justify="Justify.Center">
        <MudItem md="4" xs="4">
            <MudAlert Severity="Severity.Error" ShowCloseIcon="true" CloseIconClicked="(() => CloseAlert())">
                Login failed
            </MudAlert>
        </MudItem>
    </MudGrid>
}
<EditForm Model="_model" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator/>
    <MudGrid Justify="Justify.Center">
        <MudItem xs="4">
            <MudCard>
                <MudCardContent>
                    <MudTextField Label="Username" @bind-Value="_model.Username" For="@(() => _model.Username)"/>
                    <MudTextField Label="Password" Class="mt-3" @bind-Value="_model.Password"
                                  For="@(() => _model.Password)" InputType="InputType.Password"/>
                </MudCardContent>
                <MudCardActions>
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Login</MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>
    </MudGrid>
</EditForm>

@code
{
    private LoginModel _model = new();
    private bool _shouldRender = false;
    private bool _error = false;

    protected override bool ShouldRender() => _shouldRender;


    private async void OnValidSubmit()
    {
        LoginResponse? loginResponse = await UserService.Login(_model);
        if (loginResponse is null)
        {
            _error = true;
            _shouldRender = true;
            StateHasChanged();
        }
        else
        {
            //await SessionStorageService.SetItemAsync("kitka", "kurwa");
            await SessionStorageService.SetItemAsync("JWT_KEY", loginResponse.Token);
            await SessionStorageService.SetItemAsync("REFRESH_KEY", loginResponse.RefreshToken);

            NavigationManager.NavigateTo("/");
        }
    }

    private void CloseAlert()
    {
        _error = false;
        StateHasChanged();
    }
}